<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agenten—DB (stabil)</title>
<style>
  /* Deine bestehenden Styles hier (wegen Länge nicht kopiert) */
  body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #0a0a1a, #1a1a2e);
      color: #00ff99;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      position: relative;
      flex-direction: column;
  }
  /* ...Rest deiner Styles unverändert... */
  .footer-note {
    color: #33ffbb;
    font-size: 0.9rem;
    margin-top: 1.5rem;
    text-align: center;
    opacity: 0.8;
  }
</style>
</head>
<body>
  <div id="formPage" class="card">
    <h1>Agenten-Log in</h1>
    <p class="subtitle">Agenten, Bereiten sie sich auf ihre Mission vor</p>
    <form id="playerForm">
      <label for="nickname">Deckname</label>
      <input id="nickname" name="Nickname" required placeholder="Codename eingeben" />
      <p class="note">Bitte keinen echten Namen verwenden!</p>

      <label for="haender">Händigkeit</label>
      <select id="haender" name="haender" required>
        <option value="links">Links</option>
        <option value="rechts">Rechts</option>
      </select>

      <label for="gender">Geschlecht</label>
      <select id="gender" name="Gender" required>
        <option value="m">Männlich</option>
        <option value="w">Weiblich</option>
        <option value="d">keine Angabe</option>
      </select>

      <button type="submit">Profil sichern</button>
    </form>
    <div id="message" aria-live="polite"></div>
    <div id="debug" style="display:none;"></div>
    <div class="footer-note">Bei Problemen wenden Sie sich an die Equipmentausgabe.</div>
  </div>

  <div id="confirmationPage" class="card" style="display:none">
    <h1>Agentenprofil gespeichert</h1>
    <p class="success">Bitte lesen sie folgende Sicherheitsinstruktionen.</p>
    <label><input type="checkbox" id="securityConfirm"> Sicherheitsrichtlinien gelesen und akzeptiert</label>
    <button id="proceedBtn" disabled>Weiter zur Einsatzwarteschlange</button>
    <div id="confMessage"></div>
    <div class="footer-note">Bei Problemen wenden Sie sich an die Equipmentausgabe.</div>
  </div>

  <div id="waitingPage" class="card" style="display:none">
    <h1>Einsatzwarteschlange</h1>
    <p>Bitte warten sie. Sie werden gleich aufgerufen. Bleiben sie auf dieser Seite<span class="loader"></span></p>
    <p>Aktuelle Position: <span id="queuePos">Wird ermittelt...</span></p>
    <div id="waitingDebug" style="margin-top:8px;color:#bbb;font-size:.9rem"></div>
    <div class="footer-note">Bei Problemen wenden Sie sich an die Equipmentausgabe.</div>
  </div>

  <div id="prePage" class="card" style="display:none">
    <div class="arrow-animation"></div>
    <h1>Es geht los!</h1>
    <p>Melden Sie sich bei der Equipmentausgabe.</p>
    <button id="acknowledgeBtn">Bestätigen</button>
    <div class="footer-note">Bei Problemen wenden Sie sich an die Equipmentausgabe.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseUrl = 'https://ydqlidnpqxuwxhlpnfon.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkcWxpZG5wcXh1d3hobHBuZm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1OTgyMTMsImV4cCI6MjA3MDE3NDIxM30.EJZyB68bgmSObnSbxKInlLgMZw9_UPPgvXl6w6d0U4c';
      const TABLE_NAME = 'Players';

      const pages = {
        formPage: document.getElementById('formPage'),
        confirmationPage: document.getElementById('confirmationPage'),
        waitingPage: document.getElementById('waitingPage'),
        prePage: document.getElementById('prePage')
      };
      const messageDiv = document.getElementById('message');
      const debugDiv = document.getElementById('debug');
      const queuePos = document.getElementById('queuePos');

      let supabase;
      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        appendDebug('Supabase-Client erfolgreich initialisiert.');
      } catch (err) {
        showMessage('Fehler bei der Initialisierung von Supabase: ' + err.message, 'error');
        appendDebug('Initialisierungsfehler: ' + err.message);
        return;
      }

      function appendDebug(txt) {
        console.log(txt);
        debugDiv.style.display = '';
        debugDiv.textContent += (debugDiv.textContent ? '\n' : '') + txt;
      }

      function showMessage(text, kind = '') {
        messageDiv.textContent = text;
        messageDiv.className = kind;
      }

      function showPage(pageName) {
        for (const key in pages) {
          pages[key].style.display = (key === pageName) ? 'block' : 'none';
        }
      }

      // Prüfe Tabelle existiert
      async function checkTable() {
        appendDebug(`Prüfe Tabelle "${TABLE_NAME}"...`);
        const { data, error } = await supabase.from(TABLE_NAME).select('id').limit(1);
        if (error) {
          appendDebug(`Fehler bei Tabelle "${TABLE_NAME}": ${error.message}`);
          showMessage(`Tabelle "${TABLE_NAME}" nicht zugänglich: ${error.message}`, 'error');
          return false;
        }
        appendDebug(`Tabelle "${TABLE_NAME}" gefunden.`);
        return true;
      }

      if (!(await checkTable())) return;

      // Spielerstatus prüfen beim Laden
      async function checkPlayerStatusOnLoad() {
        const playerId = localStorage.getItem('player_id');
        if (!playerId) {
          showPage('formPage');
          return;
        }
        try {
          const { data, error } = await supabase
            .from(TABLE_NAME)
            .select('status')
            .eq('id', playerId)
            .single();

          if (error || !data) {
            appendDebug('Fehler beim Status-Abruf oder keine Daten.');
            showPage('formPage');
            return;
          }
          appendDebug(`Status des Spielers: ${data.status}`);

          switch (data.status) {
            case 'logged in':
              showPage('confirmationPage');
              break;
            case 'waiting':
              showPage('waitingPage');
              startQueuePolling();
              break;
            case 'pre':
              showPage('prePage');
              break;
            default:
              showPage('formPage');
              break;
          }
        } catch (err) {
          appendDebug('Unbekannter Fehler beim Status-Check: ' + err.message);
          showPage('formPage');
        }
      }

      // Formular-Submit
      document.getElementById('playerForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        debugDiv.textContent = '';
        showMessage('');

        const NicknameInput = document.getElementById('nickname');
        const haenderInput = document.getElementById('haender');
        const GenderInput = document.getElementById('gender');

        if (NicknameInput.value.trim().length < 2) {
          showMessage('Deckname muss mindestens 2 Zeichen lang sein.', 'error');
          return;
        }

        try {
          // Prüfen ob Nickname bereits vorhanden
          const { data: existing, error: errCheck } = await supabase
            .from(TABLE_NAME)
            .select('id')
            .eq('Nickname', NicknameInput.value.trim());

          if (errCheck) {
            appendDebug('Fehler bei Nickname-Prüfung: ' + errCheck.message);
            showMessage('Fehler bei der Prüfung des Decknamens.', 'error');
            return;
          }

          if (existing.length > 0) {
            showMessage('Dieser Deckname ist bereits registriert.', 'error');
            return;
          }

          // Prüfen ob Spieler-ID schon lokal existiert und noch in DB
          const localPlayerId = localStorage.getItem('player_id');
          if (localPlayerId) {
            const { data: existingLocal, error: errLocal } = await supabase
              .from(TABLE_NAME)
              .select('id')
              .eq('id', localPlayerId);
            if (errLocal) appendDebug('Fehler bei lokaler ID-Prüfung: ' + errLocal.message);
            else if (existingLocal.length > 0) {
              showMessage('Du bist bereits angemeldet.', 'error');
              return;
            }
          }

          // Insert in Tabelle mit Status 'logged in'
          const { data, error } = await supabase
            .from(TABLE_NAME)
            .insert([{
              Nickname: NicknameInput.value.trim(),
              haender: haenderInput.value,
              Gender: GenderInput.value,
              status: 'logged in',
              is_ready: false,
              created_at: new Date().toISOString()
            }])
            .select()
            .single();

          if (error) {
            appendDebug('Fehler beim Einfügen: ' + error.message);
            showMessage('Fehler beim Speichern.', 'error');
            return;
          }

          localStorage.setItem('player_id', data.id);
          showMessage('Profil gespeichert. Bitte lesen und bestätigen Sie die Sicherheitsinformationen.', 'success');
          showPage('confirmationPage');

        } catch (err) {
          appendDebug('Unbekannter Fehler beim Speichern: ' + err.message);
          showMessage('Unbekannter Fehler beim Speichern.', 'error');
        }
      });

      // Sicherheitsseite: Checkbox & Button
      const securityConfirmCheckbox = document.getElementById('securityConfirm');
      const proceedBtn = document.getElementById('proceedBtn');

      securityConfirmCheckbox.addEventListener('change', () => {
        proceedBtn.disabled = !securityConfirmCheckbox.checked;
      });

      proceedBtn.addEventListener('click', async () => {
        const playerId = localStorage.getItem('player_id');
        if (!playerId) {
          showMessage('Keine gültige Anmeldung gefunden. Bitte neu anmelden.', 'error');
          showPage('formPage');
          return;
        }

        proceedBtn.disabled = true;
        proceedBtn.textContent = 'Speichere...';

        try {
          const { error } = await supabase
            .from(TABLE_NAME)
            .update({ status: 'waiting', is_ready: true })
            .eq('id', playerId);

          if (error) {
            appendDebug('Fehler beim Update auf waiting: ' + error.message);
            showMessage('Fehler beim Aktualisieren des Status.', 'error');
            proceedBtn.disabled = false;
            proceedBtn.textContent = 'Weiter zur Einsatzwarteschlange';
            return;
          }

          showPage('waitingPage');
          startQueuePolling();

        } catch (err) {
          appendDebug('Unbekannter Fehler beim Status-Update: ' + err.message);
          showMessage('Unbekannter Fehler beim Status-Update.', 'error');
          proceedBtn.disabled = false;
          proceedBtn.textContent = 'Weiter zur Einsatzwarteschlange';
        }
      });

      // Warteschlange Polling
      let queuePollingInterval;
      async function updateQueue() {
        try {
          appendDebug('Starte Warteschlangen-Update...');
          const playerId = localStorage.getItem('player_id');
          if (!playerId) {
            appendDebug('Kein player_id im localStorage.');
            queuePos.textContent = 'Unbekannt';
            return;
          }

          const { data: allWaiting, error } = await supabase
            .from(TABLE_NAME)
            .select('id, created_at')
            .eq('is_ready', true)
            .order('created_at', { ascending: true });

          if (error) {
            appendDebug('Fehler beim Abrufen der Warteschlange: ' + error.message);
            queuePos.textContent = 'Fehler beim Laden';
            return;
          }

          if (!allWaiting || allWaiting.length === 0) {
            appendDebug('Keine wartenden Spieler gefunden.');
            queuePos.textContent = '1';
            return;
          }

          const position = allWaiting.findIndex(item => String(item.id) === String(playerId)) + 1;
          if (position === 0) {
            appendDebug('Spieler nicht in Warteschlange gefunden.');
            queuePos.textContent = 'Nicht in Warteschlange';
            return;
          }

          queuePos.textContent = position;
          document.getElementById('waitingDebug').textContent = `Wartende: ${allWaiting.length}, Eigene Pos: ${position}`;
          appendDebug(`Position berechnet: ${position}`);

        } catch (err) {
          appendDebug('Queue-Update-Fehler: ' + err.message);
          queuePos.textContent = 'Fehler aufgetreten';
        }
      }

      function startQueuePolling() {
        updateQueue();
        if (queuePollingInterval) clearInterval(queuePollingInterval);
        queuePollingInterval = setInterval(updateQueue, 5000);
      }

      // Stoppe Polling wenn Seite verlassen
      for (const pageName of ['formPage', 'confirmationPage', 'waitingPage', 'prePage']) {
        pages[pageName].addEventListener('transitionstart', () => {
          if (pageName !== 'waitingPage' && queuePollingInterval) {
            clearInterval(queuePollingInterval);
            appendDebug('Polling für Warteschlange beendet.');
          }
        });
      }

      // Status-Check Polling alle 5 Sekunden
      async function checkPlayerStatus() {
        const playerId = localStorage.getItem('player_id');
        if (!playerId) {
          appendDebug('Kein playerId im localStorage.');
          return;
        }

        try {
          const { data, error } = await supabase
            .from(TABLE_NAME)
            .select('status')
            .eq('id', playerId)
            .single();

          if (error) {
            appendDebug('Fehler beim Status-Abruf: ' + error.message);
            return;
          }

          appendDebug('Aktueller Status: ' + data.status);

          switch (data.status) {
            case 'pre':
              showPage('prePage');
              if (queuePollingInterval) {
                clearInterval(queuePollingInterval);
                appendDebug('Polling für Warteschlange beendet wegen Status pre.');
              }
              break;
            case 'waiting':
              if (pages.waitingPage.style.display !== 'block') {
                showPage('waitingPage');
                startQueuePolling();
              }
              break;
            case 'logged in':
              if (pages.confirmationPage.style.display !== 'block') {
                showPage('confirmationPage');
              }
              break;
            default:
              showPage('formPage');
              break;
          }
        } catch (err) {
          appendDebug('Status-Check-Fehler: ' + err.message);
        }
      }

      // Starte Status-Polling
      setInterval(checkPlayerStatus, 5000);

      // Pre-Page "Bestätigen" Button
      document.getElementById('acknowledgeBtn').addEventListener('click', async () => {
        const playerId = localStorage.getItem('player_id');
        if (!playerId) {
          showMessage('Keine gültige Anmeldung gefunden.', 'error');
          showPage('formPage');
          return;
        }
        try {
          const { error } = await supabase
            .from(TABLE_NAME)
            .update({ status: 'pre' })
            .eq('id', playerId);

          if (error) {
            appendDebug('Fehler beim Setzen des Pre-Status: ' + error.message);
            showMessage('Fehler beim Aktualisieren.', 'error');
            return;
          }
          alert('Ausrüstung bestätigt! Bereit für die Mission.');
        } catch (err) {
          appendDebug('Fehler bei Pre-Status-Update: ' + err.message);
          showMessage('Unbekannter Fehler.', 'error');
        }
      });

      // Beim Laden Status prüfen und richtige Seite zeigen
      await checkPlayerStatusOnLoad();
    });
  </script>
</body>
</html>
