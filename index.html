<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Spieler Warteschlange</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .page { display: none; }
        footer { margin-top: 30px; font-size: 0.9em; color: gray; border-top: 1px solid #ddd; padding-top: 10px; }
    </style>
</head>
<body>
    <!-- Seiten -->
    <div id="registrationPage" class="page">
        <h1>Registrierung</h1>
        <form id="registrationForm">
            <input type="text" id="name" placeholder="Name" required>
            <button type="submit">Anmelden</button>
        </form>
    </div>

    <div id="waitingPage" class="page">
        <h1>Warteschlange</h1>
        <p>Spieler vor dir: <span id="queuePos">Wird ermittelt...</span></p>
        <pre id="waitingDebug"></pre>
    </div>

    <div id="prePage" class="page">
        <h1>Vorbereitung</h1>
        <p>Bitte mach dich bereit.</p>
    </div>

    <div id="securityInfoPage" class="page">
        <h1>Sicherheitsinformation</h1>
        <p>Bitte beachte die Sicherheitsanweisungen vor Spielbeginn.</p>
    </div>

    <div id="confirmationPage" class="page">
        <h1>Best√§tigung</h1>
        <p>Du bist erfolgreich registriert.</p>
    </div>

    <footer>
        Bei Problemen wenden Sie sich an die Equipmentausgabe.
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://YOUR_PROJECT.supabase.co';
        const supabaseKey = 'YOUR_PUBLIC_ANON_KEY';
        const supabase = createClient(supabaseUrl, supabaseKey);
        const TABLE_NAME = 'players';

        const pages = {
            registrationPage: document.getElementById('registrationPage'),
            waitingPage: document.getElementById('waitingPage'),
            prePage: document.getElementById('prePage'),
            securityInfoPage: document.getElementById('securityInfoPage'),
            confirmationPage: document.getElementById('confirmationPage')
        };

        const queuePos = document.getElementById('queuePos');

        function showPage(pageName) {
            Object.values(pages).forEach(p => p.style.display = 'none');
            if (pages[pageName]) pages[pageName].style.display = 'block';
        }

        async function updateQueue(playerId) {
            try {
                const { data: allWaiting, error } = await supabase
                    .from(TABLE_NAME)
                    .select('id, created_at')
                    .eq('is_ready', true)
                    .order('created_at', { ascending: true });

                if (error) {
                    queuePos.textContent = 'Fehler';
                    return;
                }

                const myEntry = allWaiting.find(p => String(p.id) === String(playerId));
                if (!myEntry) {
                    queuePos.textContent = 'Nicht in Warteschlange';
                    return;
                }

                const playersBefore = allWaiting.filter(p => new Date(p.created_at) < new Date(myEntry.created_at));
                queuePos.textContent = playersBefore.length;
                document.getElementById('waitingDebug').textContent =
                    `Vor dir: ${playersBefore.length}, Gesamt: ${allWaiting.length}`;
            } catch (err) {
                queuePos.textContent = 'Fehler';
            }
        }

        async function checkStatusOnLoad() {
            const savedPlayerId = localStorage.getItem('player_id');
            if (!savedPlayerId) {
                showPage('registrationPage');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('status, is_ready, created_at')
                    .eq('id', savedPlayerId)
                    .single();

                if (error || !data) {
                    showPage('registrationPage');
                    return;
                }

                if (data.status === 'waiting') {
                    showPage('waitingPage');
                    updateQueue(savedPlayerId);
                    setInterval(() => updateQueue(savedPlayerId), 5000);
                } else if (data.status === 'pre') {
                    showPage('prePage');
                } else if (data.status === 'logged in') {
                    showPage('securityInfoPage');
                } else {
                    showPage('confirmationPage');
                }
            } catch {
                showPage('registrationPage');
            }
        }

        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            if (!name) return;

            const { data, error } = await supabase
                .from(TABLE_NAME)
                .insert([{ name, status: 'waiting', is_ready: true }])
                .select()
                .single();

            if (!error && data) {
                localStorage.setItem('player_id', data.id);
                showPage('waitingPage');
                updateQueue(data.id);
                setInterval(() => updateQueue(data.id), 5000);
            }
        });

        checkStatusOnLoad();
    </script>
</body>
</html>
